<div class="container-fluid vh-100 bg-dark text-light p-0">
  <div class="row h-100 g-0">
    <!-- USERS -->
    <div class="col-3 border-end border-secondary bg-dark d-flex flex-column">

      <!-- CHAT LIST HEADER -->
      <div class="p-3 border-bottom border-secondary fw-bold d-flex justify-content-between align-items-center flex-shrink-0">
        Chats
        <button
          class="btn btn-sm btn-outline-primary"
          (click)="showSearch = !showSearch">
          <i class="bi bi-person-plus"></i>
        </button>
      </div>

      <!-- SEARCH NEW USER -->
      <div class="p-2 border-bottom border-secondary flex-shrink-0" *ngIf="showSearch">
        <input
          type="text"
          class="form-control bg-dark text-light border-secondary"
          placeholder="Search new user..."
          [(ngModel)]="searchTerm"
          (input)="applyFilter()" />
      </div>

      <!-- SEARCH RESULTS -->
      <ul class="list-group list-group-flush" *ngIf="showSearch && filteredUsers.length" style="overflow-y: auto; flex-shrink: 0;">
        <li
          class="list-group-item list-group-item-action bg-dark text-light border-secondary"
          *ngFor="let user of filteredUsers"
          (click)="selectUser(user); showSearch=false"
          style="cursor:pointer">
          âž• {{ user.username }}
        </li>
      </ul>

      <!-- CHAT USERS -->
      <ul class="list-group list-group-flush flex-grow-1 overflow-auto">
        <li
          class="list-group-item d-flex align-items-center gap-2 bg-dark text-light border-secondary"
          *ngFor="let user of chatUsers"
          (click)="selectUser(user)"
          [class.active]="selectedUser?.id === user.id"
          style="cursor:pointer">

          <i class="bi bi-circle-fill"
             [class.text-success]="user.isOnline"
             [class.text-secondary]="!user.isOnline"
             style="font-size: 10px"></i>

          {{ user.username }}
        </li>
      </ul>

    </div>

    <!-- CHAT -->
    <div class="col-9 d-flex flex-column bg-dark p-0 h-100">

      <ng-container *ngIf="selectedUser; else emptyChat">

        <!-- HEADER - FIXED -->
        <div class="border-bottom border-secondary p-3 fw-bold bg-dark flex-shrink-0">
          <i class="bi bi-chat-dots"></i>
          {{ selectedUser.username }}
        </div>

        <!-- MESSAGES - SCROLLABLE AREA -->
        <div class="flex-grow-1 overflow-auto p-3" #messagesContainer style="min-height: 0;">

          <div *ngFor="let msg of messages"
               class="mb-2 d-flex"
               [class.justify-content-end]="msg.senderId === currentUser?.id">

            <div
              class="p-2 rounded"
              [class.bg-primary]="msg.senderId === currentUser?.id"
              [class.text-white]="msg.senderId === currentUser?.id"
              [class.bg-secondary]="msg.senderId !== currentUser?.id"
              style="max-width: 60%">
              {{ msg.content }}
              <div class="text-end small opacity-75">
                {{ formatTime(msg.timestamp) }}
              </div>
            </div>

          </div>
        </div>

        <!-- INPUT -->
        <div class="border-top border-secondary p-3 bg-dark d-flex gap-2 flex-shrink-0">
          <input
            type="text"
            class="form-control bg-dark text-light border-secondary"
            [(ngModel)]="newMessage"
            placeholder="Type a message..."
            (keyup.enter)="sendMessage()" />

          <button class="btn btn-primary" (click)="sendMessage()">
            <i class="bi bi-send"></i>
          </button>
        </div>

      </ng-container>

      <ng-template #emptyChat>
        <div class="h-100 d-flex justify-content-center align-items-center text-secondary">
          ðŸ‘ˆ Select a user to start chatting
        </div>
      </ng-template>

    </div>

  </div>
</div>